# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: CMake on multiple platforms

on:
  workflow_call:
    inputs:
      build_type:
        description: Type of build (Debug, Release, RelWithDebInfo, MinSizeRel)
        type: string
        default: Debug
      devel:
        description: Whether or not this is a development build
        type: string
        default: true
      build-id:
        description: 'Identifier for workflows and caching'
        type: string
        default: 'master'

env:
  qt_version: 6.9.1
  qt_modules: qtmultimedia
  SCCACHE_GHA_ENABLED: "true"

jobs:
  summary:
    name: "Summary"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Forgejo payload
        shell: bash
        run: |
          export PAYLOAD_JSON='${{ toJSON(github.event.client_payload) }}'
          export FORGEJO_TOKEN=${{ secrets.FORGEJO_TOKEN }}
          ./.ci/parse.sh ${{ inputs.build-id }}

      - name: Create job summary
        run: |
          export FORGEJO_TOKEN=${{ secrets.FORGEJO_TOKEN }}
          ./.ci/summary.sh ${{ inputs.build-id }}

  clone:
    name: "Clone"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Forgejo payload
        shell: bash
        run: |
          export PAYLOAD_JSON='${{ toJSON(github.event.client_payload) }}'
          export FORGEJO_TOKEN=${{ secrets.FORGEJO_TOKEN }}
          ./.ci/parse.sh ${{ inputs.build-id }}

      - name: Clone
        shell: bash
        run: ./.ci/clone.sh true

      - name: Upload cloned repo
        uses: actions/upload-artifact@v4
        with:
          name: QDash
          path: |
            QDash/*
            QDash/.*

  linux:
    needs: [clone]
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs-on: ubuntu-24.04
            arch: amd64
            pkg_arch: legacy

          - runs-on: ubuntu-24.04-arm
            arch: aarch64
            pkg_arch: aarch64

    runs-on: ${{ matrix.runs-on }}
    name: "Linux (${{ matrix.arch }})"
    container: ghcr.io/pkgforge-dev/archlinux:latest

    steps:
      - name: Install git
        run: pacman -Syu --noconfirm git

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          git config --global --add safe.directory $PWD

          chmod +x ./.ci/linux/get-dependencies.sh
          ./.ci/linux/get-dependencies.sh

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          key: ${{ runner.os }}-${{ matrix.arch }}-${{ inputs.build_type }}

      - name: Parse Forgejo payload
        shell: bash
        run: |
          export PAYLOAD_JSON='${{ toJSON(github.event.client_payload) }}'
          export FORGEJO_TOKEN=${{ secrets.FORGEJO_TOKEN }}
          ./.ci/parse.sh ${{ inputs.build-id }}

      - name: Clone
        uses: actions/download-artifact@v4
        with:
          name: QDash

      - name: Configure & Build
        run: |
          export TARGET=appimage
          export BUILD_TYPE=${{ inputs.build_type }}
          export USE_CCACHE=true

          chmod a+x .ci/linux/build.sh
          .ci/linux/build.sh ${{ matrix.pkg_arch }}

      - name: Package (AppImage)
        run: |
          export DEVEL=${{ inputs.devel }}

          chmod a+x .ci/linux/build.sh
          .ci/linux/package.sh ${{ matrix.pkg_arch }}

      - name: Package (binary)
        run: |
          cmake --install build --prefix install/usr

          cd install
          tar --owner root --group root --zstd -cf QDash.tar.zst *

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary-${{ matrix.arch }}
          path: QDash.tar.zst

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          path: *.AppImage*

  windows:
    needs: [clone]
    name: "Windows (${{ matrix.arch }})"
    runs-on: ${{ matrix.runs-on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - runs-on: windows-latest
            arch: amd64

          - runs-on: windows-11-arm
            arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.qt_version }}
          modules: ${{ env.qt_modules }}
          cache: 'true'

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - uses: repolevedavaj/install-nsis@v1.0.2
        with:
          nsis-version: 3.09

      - name: Install Python Dependencies
        run: |
          pip install jinja2

      - name: Setup CCache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ matrix.arch }}-${{ inputs.build_type }}

      - name: Parse Forgejo payload
        shell: bash
        run: |
          export PAYLOAD_JSON='${{ toJSON(github.event.client_payload) }}'
          export FORGEJO_TOKEN=${{ secrets.FORGEJO_TOKEN }}
          ./.ci/parse.sh ${{ inputs.build-id }}

      - name: Clone
        uses: actions/download-artifact@v4
        with:
          name: QDash

      - name: Build
        shell: bash
        run: |
          export DEVEL=true
          export WINDEPLOYQT=windeployqt
          export USE_CCACHE=true

          ./.ci/windows/build.sh

      - name: Package (Binary)
        shell: bash
        run: |
          export ARCH=${{ matrix.arch }}
          ./.ci/windows/package.sh

      - name: Package (Installer)
        shell: cmd
        run: |
          cd build/pkg
          makensis -NOCD "../dist/win_install.nsi"

      - name: Upload (Binary)
        uses: actions/upload-artifact@v4.6.2
        with:
          name: windows-${{ matrix.arch }}
          path: artifacts/*

      - name: Upload (Installer)
        uses: actions/upload-artifact@v4
        with:
          name: windows-setup-${{ matrix.arch }}
          path: QDash-Setup.exe

  macos:
    needs: [clone]
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs-on: macos-latest

    runs-on: ${{ matrix.runs-on }}
    name: "macOS (universal)"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.qt_version }}
          modules: ${{ env.qt_modules }}
          cache: 'true'

      - name: Install CMake
        uses: lukka/get-cmake@v4.0.1

      - name: Setup CCache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ inputs.build_type }}

      - name: Set up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: 3.8
          cache: 'pip'

      - name: Install Dependencies
        run: |
          brew update
          brew install llvm
          pip install jinja2

      - name: Parse Forgejo payload
        shell: bash
        run: |
          export PAYLOAD_JSON='${{ toJSON(github.event.client_payload) }}'
          export FORGEJO_TOKEN=${{ secrets.FORGEJO_TOKEN }}
          ./.ci/parse.sh ${{ inputs.build-id }}

      - name: Clone
        uses: actions/download-artifact@v4
        with:
          name: QDash

      - name: Configure & Build
        run: |
          export USE_CCACHE=true
          export BUILD_TYPE=${{ inputs.build_type }}

          chmod a+x .ci/macos/build.sh
          .ci/macos/build.sh

      - name: Package
        run: |
          export QML_SOURCES_PATHS="$QML2_IMPORT_PATH"

          chmod a+x .ci/macos/package.sh
          .ci/macos/package.sh

      - name: Upload app
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: QDash.tar.gz
